<html>
<head>
    <style>
        input.error {
            border: 1px solid red;
            color: red;
        }
        span.error {
            color: red;
        }
        span.success {
            color: green;
        }
    </style>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>

    <script src="state.js"></script>

    <script type="text/javascript">
        $(function() {
            var username = stateful($('#username')).state({
                empty: {
                    initial: true,
                },
                available: {
                    initial: false
                },
                valid: {
                    change: function(value) {
                        if (!value) {
                            this.object.addClass('error');
                        } else {
                            this.object.removeClass('error');
                        }
                    },

                    compute: function() {
                        return !this.state('empty') && this.state('available');
                    }
                }
            }).behavior({
                keyup: function() {
                    this.state('available', (Math.random() > 0.5));
                    this.state('empty', _.isEmpty(this.object.val()));
                }
            });

            var availability = stateful($('#availability')).inject({
                'username': username
            }).state({
                ok: {
                    change: function(value) {
                        this.object.removeClass(value ? 'error' : 'success');
                        this.object.addClass(value ? 'success' : 'error');
                        this.object.html((value ? '' : 'Not ') + 'Available!');
                    },

                    compute: function() {
                        return this.deps('username').state('available');
                    }
                }
            });

            var password = stateful($('#password')).state({
                empty: {
                    initial: true
                },
                strong: {},
                valid: {
                    change: function(value) {
                        this.object.removeClass(value ? 'error' : 'success');
                        this.object.addClass(value ? 'success' : 'error');
                    },
                    compute: function() {
                        return !this.state('empty');
                    }
                }
            }).behavior({
                keyup: function() {
                    var value = this.object.val();
                    this.state('empty', _.isEmpty(value));
                    this.state('strong', value.length >= 5);
                }
            });

            var strength = stateful($('#strength')).inject({
                password: password
            }).state({
                strong: {
                    change: function(value) {
                        this.object.removeClass(value ? 'error' : 'success');
                        this.object.addClass(value ? 'success' : 'error');
                        this.object.html(value ? 'Strong' : 'Weak');
                    },

                    compute: function() {
                        return this.deps('password').state('strong');
                    }
                }
            });

            var button = stateful($('#button')).inject({
                username: username,
                password: password
            }).state({
                enabled: {
                    noticeInitial: true,

                    change: function(value) {
                        if (value) {
                            this.object.removeAttr('disabled');
                        } else {
                            this.object.attr('disabled', 'disabled');
                        }
                    },

                    compute: function() {
                        return this.deps('username').state('valid') && this.deps('password').state('valid');
                    }
                }
            });
        });
    </script>
</head>
<body>
    <div>
        <input type="text" id="username" />
        <span id="availability"></span>
    </div>
    <div>
        <input type="password" id="password" />
        <span id="strength"></span>
    </div>
    <div>
        <button id="button">Register</button>
    </div>
</body>
</html>